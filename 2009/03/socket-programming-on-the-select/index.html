<!DOCTYPE html>
<html lang="en"
>
<head>
    <title>Socket编程之Select【转载】 - Log4D</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />



<link rel="canonical" href="http://blog.log4d.com/2009/03/socket-programming-on-the-select/">

        <meta name="author" content="alswl" />
        <meta name="keywords" content="C,网络编程" />
        <meta name="description" content="这篇文章讲的是Socket中的select，我觉得还不错就转来了 出处：http://www.cnblogs.com/xuyuan77/articles/1206418.html 感谢原作者 Select在Socket编程中还是比较重要的，可是对于初学Socket的人来说都不太爱用Select写程序，他们只是习惯写诸如connect、accept 、recv或recvfrom这样的阻塞程序（所谓阻塞方式block，顾名思义，就是进程或是线程执行到这些函数时必须等待某个事件的发生，如果事件没有发生，进程 或线程就被阻塞，函数不能立即返回）。可是使用Select就可以完成非阻塞（所谓非阻塞方式non-block，就是进程或线程执行此函数时不必非要等待事件的发生 ，一旦执行肯定返回，以返回值的不同来反映函数的执行情况，如果事件发生则与阻塞方式相同，若事件没有发生则返回一个代码来告知事件未发生，而进程或线程继续执行，所 以效率较高）方式工作的程序，它能够监视我们需要监视的文件描述符的变化情况——读写或是异常。 下面详细介绍一下！ Select的函数格式(我所说的是Unix系统下的伯克利socket编程 ..." />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://blog.log4d.com/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="http://blog.log4d.com/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://blog.log4d.com/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="http://blog.log4d.com/theme/css/style.css" type="text/css"/>

    <link href="http://blog.log4d.com/atom.xml" type="application/atom+xml" rel="alternate" title="Log4D Atom Feed" />
    <link href="http://blog.log4d.com/rss.xml" type="application/rss+xml" rel="alternate" title="Log4D RSS Feed" />

</head>
<body>

<div class="navbar navbar-default" role="navigation">
    <div class="container  col-lg-8 col-lg-offset-2">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://blog.log4d.com/" class="navbar-brand">
Log4D            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="/tags/">Tags</a></li>
                    <li><a href="/links/">Links</a></li>
                    <li><a href="/about/">About</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://blog.log4d.com/archives/"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<div class="container">
    <div class="row">
        <div class="col-lg-8 col-lg-offset-2">

    <section id="content">
        <article class="article-detail">
            <header class="page-header">
                <h1 class="title">
                    <a href="http://blog.log4d.com/2009/03/socket-programming-on-the-select/"
                       rel="bookmark"
                       title="Permalink to Socket编程之Select【转载】">
                        Socket编程之Select【转载】
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2009-03-24T00:00:00"> 2009-03-24</time>
    </span>



<span class="label label-default">Tags</span>
	<a href="http://blog.log4d.com/tag/c/">C</a>
        /
	<a href="http://blog.log4d.com/tag/wang-luo-bian-cheng/">网络编程</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>这篇文章讲的是Socket中的select，我觉得还不错就转来了</p>
<p>出处：<a href="http://www.cnblogs.
com/xuyuan77/articles/1206418.html">http://www.cnblogs.com/xuyuan77/articles/1206418.html</a></p>
<p>感谢原作者</p>
<p>Select在Socket编程中还是比较重要的，可是对于初学Socket的人来说都不太爱用Select写程序，他们只是习惯写诸如connect、accept
、recv或recvfrom这样的阻塞程序（所谓阻塞方式block，顾名思义，就是进程或是线程执行到这些函数时必须等待某个事件的发生，如果事件没有发生，进程
或线程就被阻塞，函数不能立即返回）。可是使用Select就可以完成非阻塞（所谓非阻塞方式non-block，就是进程或线程执行此函数时不必非要等待事件的发生
，一旦执行肯定返回，以返回值的不同来反映函数的执行情况，如果事件发生则与阻塞方式相同，若事件没有发生则返回一个代码来告知事件未发生，而进程或线程继续执行，所
以效率较高）方式工作的程序，它能够监视我们需要监视的文件描述符的变化情况——读写或是异常。</p>
<p>下面详细介绍一下！</p>
<p>Select的函数格式(我所说的是Unix系统下的伯克利socket编程，和windows下的有区别，一会儿说明)：</p>
<p>int select(int maxfdp,fd_set <em>readfds,fd_set </em>writefds,fd_set <em>errorfds,struct
timeval </em>timeout);</p>
<p>先说明两个结构体：</p>
<p>第一，struct fd_set可以理解为一个集合，这个集合中存放的是文件描述符(file descriptor)，即文件句柄，这可以是我们所说的普通意义的
文件，当然Unix下任何设备、管道、FIFO等都是文件形式，全部包括在内，所以毫无疑问一个socket就是一个文件，socket句柄就是一个文件描述符。fd
_set集合可以通过一些宏由人为来操作，比如清空集合FD_ZERO(fd_set <em>)，将一个给定的文件描述符加入集合之中FD_SET(int
,fd_set </em>)，将一个给定的文件描述符从集合中删除FD_CLR(int
,fd_set<em>)，检查集合中指定的文件描述符是否可以读写FD_ISSET(int ,fd_set</em> )。一会儿举例说明。</p>
<p>第二，struct timeval是一个大家常用的结构，用来代表时间值，有两个成员，一个是秒数，另一个是毫秒数。</p>
<p>具体解释select的参数：</p>
<p>int
maxfdp是一个整数值，是指集合中所有文件描述符的范围，即所有文件描述符的最大值加1，不能错！在Windows中这个参数的值无所谓，可以设置不正确。</p>
<p>fd_set *readfds是指向fd_set结构的指针，这个集合中应该包括文件描述符，我们是要监视这些文件描述符的读变化的，即我们关心是否可以从这些文件
中读取数据了，如果这个集合中有一个文件可读，select就会返回一个大于0的值，表示有文件可读，如果没有可读的文件，则根据timeout参数再判断是否超时，
若超出timeout的时间，select返回0，若发生错误返回负值。可以传入NULL值，表示不关心任何文件的读变化。</p>
<p>fd_set *writefds是指向fd_set结构的指针，这个集合中应该包括文件描述符，我们是要监视这些文件描述符的写变化的，即我们关心是否可以向这些文
件中写入数据了，如果这个集合中有一个文件可写，select就会返回一个大于0的值，表示有文件可写，如果没有可写的文件，则根据timeout参数再判断是否超时
，若超出timeout的时间，select返回0，若发生错误返回负值。可以传入NULL值，表示不关心任何文件的写变化。</p>
<p>fd_set *errorfds同上面两个参数的意图，用来监视文件错误异常。</p>
<p>struct timeval* timeout是select的超时时间，这个参数至关重要，它可以使select处于三种状态，第一，若将NULL以形参传入，即
不传入时间结构，就是将select置于阻塞状态，一定等到监视文件描述符集合中某个文件描述符发生变化为止；第二，若将时间值设为0秒0毫秒，就变成一个纯粹的非阻
塞函数，不管文件描述符是否有变化，都立刻返回继续执行，文件无变化返回0，有变化返回一个正值；第三，timeout的值大于0，这就是等待的超时时间，即sele
ct在timeout时间内阻塞，超时时间之内有事件到来就返回了，否则在超时后不管怎样一定返回，返回值同上述。</p>
<p>返回值：</p>
<p>负值：select错误 正值：某些文件可读写或出错 0：等待超时，没有可读写或错误的文件</p>
<p>在有了select后可以写出像样的网络程序来！</p>
<p>举个简单的例子，就是从网络上接受数据写入一个文件中。</p>
<p>例子：</p>
<p><img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/None.gif" />main()
<img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/ExpandedBlockStart.gif" />{
<img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" /> int sock;
<img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" /> FILE <em>fp;
<img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" /> struct
fd_set fds; <img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubB" title="lockStart.gif" /> struct timeval timeout={3,0}; //select等待3秒，3秒轮询，要非阻塞就置0 <img alt="image" src="htt" title="p://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif" /> char
buffer[256]={0}; //256字节的接收缓冲区
<img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" /> <img alt="image" src="http://" title="www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif" /> /</em>
假定已经建立UDP连接，具体过程不写，简单，当然TCP也同理，主机ip和port都已经给定，要写的文件已经打开
<img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" />
sock=socket(<img alt="image" src="http://www.cnblogs.com/Images/dot.gif" />);
<img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" />
bind(<img alt="image" src="http://www.cnblogs.com/Images/dot.gif" />);
<img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif" />
fp=fopen(<img alt="image" src="http://www.cnblogs.com/Images/dot.gif" />); */
<img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" />
<img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" /> while(1) <img alt="
" src="http://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif" />
{ <img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" />
FD_ZERO(&amp;fds); //每次循环都要清空集合，否则不能检测描述符变化
<img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" />
FD_SET(sock,&amp;fds); //添加描述符
<img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" />
FD_SET(fp,&amp;fds); //同上
<img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" />
maxfdp=sock&gt;fp?sock+1:fp+1; //描述符最大值加1
<img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" />
switch(select(maxfdp,&amp;fds,&amp;fds,NULL,&amp;timeout)) //select使用 <img alt="image" src="http://www.cnblo" title="gs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif" /> {
<img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" /> case -1:
<img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" />
exit(-1);break; //select错误，退出程序
<img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" /> case 0:
<img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" /> break;
//再次轮询 <img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" />
default: <img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" />
if(FD_ISSET(sock,&amp;fds)) //测试sock是否可读，即是否网络上有数据 <img alt="image" src="http://www.cnblogs.com/Imag" title="es/OutliningIndicators/ExpandedSubBlockStart.gif" /> {
<img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" /> recvfrom(so
ck,buffer,256,<img alt="image" src="http://www.cnblogs.com/Images/dot.gif" />..);//接受网络数据
<img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" />
if(FD_ISSET(fp,&amp;fds)) //测试文件是否可写
<img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" />
fwrite(fp,buffer<img alt="image" src="http://www.cnblogs.com/Images/dot.gif" />);//写入文件
<img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" /> buffer清空;
<img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif" />
}// end if break;
<img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif" />
}// end switch
<img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif" />
}//end while <img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/ExpandedBlo" title="ckEnd.gif" />}//end main
<img alt="image" src="http://www.cnblogs.com/Images/OutliningIndicators/None.gif" /></p>
            </div>
            <!-- /.entry-content -->
              
<hr>
<div class="panel">
<div class="panel-body">
   <small>原文链接: <a href="http://blog.log4d.com/2009/03/socket-programming-on-the-select/">http://blog.log4d.com/2009/03/socket-programming-on-the-select/</a></small><br>
   <small>3a1ff193cee606bd1e2ea554a16353ee</small>
</div>
</div>

<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
	<span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_tools_1"></a>
	<a class="jiathis_button_tools_2"></a>
	<a class="jiathis_button_tools_3"></a>
	<a class="jiathis_button_tools_4"></a>
	<a href="http://www.jiathis.com/share?uid=1604940" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
	<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config = {data_track_clickback:'true'};
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1604940" charset="utf-8"></script>
<!-- JiaThis Button END -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'log4d'; // required: replace example with your forum shortname

                    var disqus_identifier = 'socket-programming-on-the-select';
                var disqus_url = 'http://blog.log4d.com/2009/03/socket-programming-on-the-select/';

            var disqus_config = function () {
                this.language = "en";
            };

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        </script>
		<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
		<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    

    </section>
        </article>
    </section>

        </div>
        <div class="col-lg-3 col-lg-offset-2" id="sidebar">

<aside>
    <section>
        <ul class="list-group list-group-flush">
                <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
                  <ul class="list-group" id="social">
                    <li class="list-group-item"><a href="http://blog.log4d.com/atom.xml"><i class="fa fa-rss-square fa-lg"></i> RSS</a></li>
                    <li class="list-group-item"><a href="http://twitter.com/alswl"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
                    <li class="list-group-item"><a href="https://github.com/alswl"><i class="fa fa-github-square fa-lg"></i> Github</a></li>
                    <li class="list-group-item"><a href="http://weibo.com/alswlx"><i class="fa fa-weibo fa-lg"></i> Weibo</a></li>
                  </ul>
                </li>




        </ul>
    </section>

</aside>        </div>
    <div class="col-lg-3" id="sidebar">
<aside>
    <section>
        <ul class="list-group list-group-flush">
                <li class="list-group-item"><a href="http://blog.log4d.com/"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Categories</span></h4></a>
                    <ul class="list-group" id="categories">
                        <li class="list-group-item">
                            <a href="http://blog.log4d.com/category/coding/">
                                <i class="fa fa-folder-open fa-lg"></i> Coding
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://blog.log4d.com/category/efficiency/">
                                <i class="fa fa-folder-open fa-lg"></i> Efficiency
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://blog.log4d.com/category/fun/">
                                <i class="fa fa-folder-open fa-lg"></i> Fun
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://blog.log4d.com/category/internet/">
                                <i class="fa fa-folder-open fa-lg"></i> Internet
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://blog.log4d.com/category/life/">
                                <i class="fa fa-folder-open fa-lg"></i> Life
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://blog.log4d.com/category/managment/">
                                <i class="fa fa-folder-open fa-lg"></i> Managment
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://blog.log4d.com/category/thinking/">
                                <i class="fa fa-folder-open fa-lg"></i> Thinking
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://blog.log4d.com/category/ui/">
                                <i class="fa fa-folder-open fa-lg"></i> UI
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://blog.log4d.com/category/view/">
                                <i class="fa fa-folder-open fa-lg"></i> View
                            </a>
                        </li>
                    </ul>
                </li>


        </ul>
    </section>

</aside>    </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2015 alswl
            &middot; Powered by <a href="https://github.com/alswl/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://blog.log4d.com/theme/js/jquery.min.js"></script>
<!--<script src="http://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>-->

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://blog.log4d.com/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://blog.log4d.com/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'log4d'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-8822123-3']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->
</body>
</html>