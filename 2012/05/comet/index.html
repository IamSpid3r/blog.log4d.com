<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">
<head>
    <title>服务器 Push 技术</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Open Graph tags -->

            <meta property="og:type" content="article"/>
            <meta property="og:title" content="服务器 Push 技术"/>
            <meta property="og:url" content="/2012/05/comet/"/>
            <meta property="og:description" content="服务器 Push 技术表示服务器可以主动推送消息给客户端浏览器。 实现方式 Comet Ajax 轮询 iframe / htmlfile script tag （不中断的连续请求） Flash 通讯 WebSocket Comet 本意是彗星，彗星尾巴痕迹很像长连接工作方式，所以 Comet 指代长连接。 在 Ajax 轮询的分类上，存在一些分歧，这里我把轮询认为一种 Comet 方式。 ps：「长连接」在一些场景下，是另外一种意义「HTTP: Keep alive」。不在本文讨论的范围中。 参考链接： Comet：基于 HTTP 长连接的「服务器推」技术 Socket.IO Supported transports"/>

    <!-- Bootstrap -->
        <link rel="stylesheet" href="/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="/theme/css/font-awesome.min.css" rel="stylesheet">
    <link href="/theme/css/pygments.css" rel="stylesheet">
    <link rel="stylesheet" href="/theme/css/style.css" type="text/css"/>
    <!-- JavaScript plugins (requires jQuery) -->
    <script src="http://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>

    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Log4D Atom Feed" />
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Log4D RSS Feed" />

    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-8822123-3']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();

    </script>
</head>
<body>
<nav class="navbar navbar-default" role="navigation">
    <div class="container col-lg-8 col-lg-offset-2">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="/" class="navbar-brand">Log4D</a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="/tags/">Tags</a></li>
                    <li><a href="/links/">Links</a></li>
                    <li><a href="/about/">About</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="/archives/"><i class="icon-th-list"></i>Archives</a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</nav>
<!-- /.navbar -->
<div class="container">
    <div class="row">
        <div class="col-lg-8 col-lg-offset-2">
    <section id="content">
        <article class="article-detail">
            <header class="page-header">
                <h1 class="text-center">
                    <a href="/2012/05/comet/"
                       rel="bookmark"
                       title="Permalink to 服务器 Push 技术">
                        服务器 Push 技术
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="icon-calendar"></i>2012-05-30
    </span>



<span class="label label-default">Tags</span>
	<a href="/tag/comet/">Comet</a>
        /
	<a href="/tag/rabbitmq/">RabbitMQ</a>
        /
	<a href="/tag/socketio/">Socket.IO</a>
        /
	<a href="/tag/nodejs/">Node.JS</a>
        /
	<a href="/tag/ampq/">AMPQ</a>
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>服务器 Push 技术表示服务器可以主动推送消息给客户端浏览器。</p>
<h2>实现方式</h2>
<ul>
<li>Comet</li>
<li>Ajax 轮询</li>
<li>iframe / htmlfile</li>
<li>script tag （不中断的连续请求）</li>
<li>Flash 通讯</li>
<li>WebSocket</li>
</ul>
<p>Comet 本意是彗星，彗星尾巴痕迹很像长连接工作方式，所以 Comet 指代长连接。
在 Ajax 轮询的分类上，存在一些分歧，这里我把轮询认为一种 Comet 方式。</p>
<p>ps：「长连接」在一些场景下，是另外一种意义「HTTP: Keep alive」。不在本文讨论的范围中。</p>
<p>参考链接：</p>
<ul>
<li><a href="http://www.ibm.com/developerworks/cn/web/wa-lo-comet/">Comet：基于 HTTP 长连接的「服务器推」技术</a></li>
<li><a href="http://socket.io/#browser-support">Socket.IO Supported transports</a></li>
</ul>


<h3>浏览器支持情况</h3>
<p>WebSocket 属于 HTML5 规范，需要「先进」浏览器支持，
Flash 通讯需要浏览器安装 Flash 插件，其他方式都可以适应常见浏览器。</p>
<p>参考连接：</p>
<ul>
<li><a href="http://zh.wikipedia.org/wiki/HTTP持久链接">HTTP持久链接</a></li>
<li>[Comet (programming)](http://en.wikipedia.org/wiki/Comet_(programming))</li>
<li><a href="http://www.cnblogs.com/tianzhiliang/archive/2011/06/13/2079564.html">一个误解: 单个服务器程序可承受最大连接数「理论」上是「65535」</a></li>
<li><a href="http://www.zeitoun.net/articles/comet_and_php/start">How to implement COMET with PHP</a></li>
</ul>
<h2>各大网站连接情况</h2>
<p>可以通过 url 请求来揣测一些东西，比如说，它们没有用 WebSocket，
否则 FireBug 是无法监测的，WebSocket 可以双向通讯。</p>
<h3>新浪微博</h3>
<p>未读信息链接： <code>http://rm.api.weibo.com/remind/unread_count.json?target=api&amp;_pid=10001&amp;count=2&amp;source=3818214747&amp;callback=STK_133834300664875</code></p>
<p>未读信息大约每20秒触发一次，像是 Ajax 轮询。</p>
<p>IM 长连接：
<code>http://4.46.web1.im.weibo.com/im?jsonp=parent.org.cometd.script._callback5&amp;message=%5B%7B%22channel%22%3A%22%2Fmeta%2Fconnect%22%2C%22connectionType%22%3A%22callback-polling%22%2C%22id%22%3A6%2C%22clientId%22%3A%22b02qp9qw9cgiuxxyn3%22%7D%5D&amp;1338343019008</code></p>
<p>可以看出新浪在使用 JSONP 跨域做 IM 长连接，FireBug 中也始终有链接请求，
看上去像 Script Tag 请求方式。</p>
<h3>知乎</h3>
<p>请求链接：
<code>http://comet.zhihu.com/update?loc=http%3A%2F%2Fwww.zhihu.com%2F&amp;channel=13781e6817833300f0a70f19&amp;callback=zhp13781e6a6f22349b9865b47c8</code></p>
<p>依然能在 FireBug 中看到请求地址，说明客户端请求数据还是走 HTTP 方式，
并且会出现 update 动作链接一直出于请求状态，猜测知乎仍然使用 Script Tag 请求。</p>
<h2>框架支持</h2>
<h3>orbited2</h3>
<p><a href="http://labs.gameclosure.com/orbited2/">http://labs.gameclosure.com/orbited2/</a></p>
<ul>
<li>跨浏览器</li>
<li>容易集成：IRC / XMPP / ActiveMQ / RabbitMQ</li>
<li>Python</li>
</ul>
<h3>StreamHub</h3>
<p><a href="http://www.stream-hub.com/">http://www.stream-hub.com/</a></p>
<ul>
<li>免费版仅支持 10 个在线</li>
<li>支持 Java / .net / iPhone</li>
</ul>
<h3>socket.io</h3>
<p><a href="http://socket.io/">http://socket.io/</a></p>
<ul>
<li>NodeJS</li>
<li>推送方式：</li>
<li>WebSocket</li>
<li>Adobe® Flash® Socket</li>
<li>AJAX long polling</li>
<li>AJAX multipart streaming</li>
<li>Forever Iframe</li>
<li>JSONP Polling</li>
<li>支持浏览器：</li>
<li>Internet Explorer 5.5+</li>
<li>Safari 3+</li>
<li>Google Chrome 4+</li>
<li>Firefox 3+</li>
<li>Opera 10.61+</li>
<li>iPhone Safari</li>
<li>iPad Safari</li>
<li>Android WebKit</li>
<li>WebOs WebKit</li>
</ul>
<h3>sockjs-client</h3>
<p><a href="https://github.com/sockjs/sockjs-client">https://github.com/sockjs/sockjs-client</a></p>
<ul>
<li>支持 Node.js / Erlang / Lua / Python-Tornado</li>
<li>跨浏览器</li>
</ul>
<h2>实战 Socket.io</h2>
<p>考虑到上述候选框架的使用场景，这里选择 Socket.IO 作为 Comet 框架。</p>
<h3>尴尬的 Pylons</h3>
<p>Pylons 和 Comet 配合有问题，问题处在标准 WSGI 是非异步的。
（看邮件列表里面，似乎新的标准准备支持）。</p>
<ul>
<li><a href="http://stackoverflow.com/a/3090118">http://stackoverflow.com/a/3090118</a></li>
<li><a href="http://mail.python.org/pipermail/web-sig/2008-July/003545.html">http://mail.python.org/pipermail/web-sig/2008-July/003545.html</a></li>
<li><a href="http://pypi.python.org/pypi/Spawning/">Spawning</a></li>
</ul>
<p>这样的话，我就直接选择使用 Node.JS 做 Comet 服务器，Nginx 负责转发。</p>
<h3>简单Demo</h3>
<p>node.js 代码</p>
<p>```js app.js
/<em> global __dirname, console </em>/</p>
<p>var app = require('http').createServer(handler),
    io = require('socket.io').listen(app),
    fs = require('fs');</p>
<p>app.listen(8080);</p>
<p>function handler(req, res) {
    fs.readFile(__dirname + '/index.html',
        function (err, data) {
            if (err) {
                res.writeHead(500);
                return res.end('Error loading index.html');
            }</p>
<div class="highlight"><pre>        <span class="n">res</span><span class="p">.</span><span class="n">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
        <span class="n">res</span><span class="p">.</span><span class="n">end</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
    <span class="p">});</span>
</pre></div>


<p>}</p>
<p>io.sockets.on('connection', function (socket) {
    'use strict';
    socket.emit('news', {hello: 'world, for everyone!'});
    socket.on('my other event', function (data) {
        console.log(data);
    });
    socket.on('private message', function (from, msg) {
        console.log('I received a private message by ', from, ' saying ', msg);
    });
});</p>
<div class="highlight"><pre><span class="err">页面代码</span>

<span class="sb">``</span><span class="err">`</span> <span class="nx">html</span> <span class="nx">index.html</span> 
<span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nb">head</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nb">meta</span> <span class="nx">http</span><span class="na">-equiv</span><span class="o">=</span><span class="s2">&quot;content-type&quot;</span> <span class="n">content</span><span class="o">=</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">&gt;</span>

    <span class="o">&lt;</span><span class="nb">title</span><span class="o">&gt;</span><span class="nx">Socket.io</span> <span class="nx">Demo</span><span class="o">&lt;/</span><span class="nb">title</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nb">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;/socket.io/socket.io.js&quot;</span><span class="o">&gt;&lt;/</span><span class="nb">script</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nb">script</span><span class="o">&gt;</span>
        <span class="kd">var</span> <span class="n">socket</span> <span class="o">=</span> <span class="nx">io.connect</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>

        <span class="nx">socket.on</span><span class="p">(</span><span class="s1">&#39;news&#39;</span><span class="p">,</span> <span class="nx">function</span> <span class="p">(</span><span class="kd">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console.log</span><span class="p">(</span><span class="kd">data</span><span class="p">);</span>
            <span class="nx">socket.emit</span><span class="p">(</span><span class="s1">&#39;my other event&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">my</span><span class="p">:</span> <span class="s1">&#39;data&#39;</span> <span class="p">});</span>
        <span class="p">});</span>
    <span class="o">&lt;/</span><span class="nb">script</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="nb">head</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nb">body</span><span class="o">&gt;</span>

<span class="o">&lt;/</span><span class="nb">body</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="nx">html</span><span class="o">&gt;</span>
</pre></div>


<p>连接成功之后，在浏览器控制台里面，可以使用 <code>socket.emit('my other event', {biu: 'biu'});</code>
向服务器发送消息。</p>
<p>服务器也可以通过 <code>socket.emit()</code> 来向客户端推送消息。</p>
<p>私有信息发送，使用 <code>socket.emit('private message', 'James', {some: 'message'});</code> 。</p>
<h3>跨平台</h3>
<p>实测看来，在 IE8 下面， Socket.io 会降级使用 <code>htmlfile</code> 来实现 Comet。</p>
<p>而 Firefox 中会有 <code>websocket / htmlfile / xhr-polling / jsonp-polling</code> 依次备选，
首选 websocket。</p>
<h3>安全性</h3>
<p>问题：提交数据的身份认证过程，以前在后台由 Web 框架自动完成，而现在流程是
Socket.IO -&gt; RabbitMQ -&gt; Web App，身份验证的复杂度增加了。</p>
<p>思路：Socket.IO 使用 Nginx 代理转发，从而保留同一域名下面的 cookie 信息，
这样能够提交到 Socket.IO 服务器，每次 RabbitMQ Message 都记录 cookie 信息，
后台从 RabbitMQ 读取信息时候，再进行认证。</p>
<p>实际操作：由于 Comet 中的数据流仅负责推送，客户端继续使用原始 POST
方式发送数据到服务器，所以暂时不会产生身份认证问题。</p>
<h2>Node AMPQ 驱动</h2>
<p>Socket.IO 提供了一个通用的 Comet 解决方案，下面就需要点润滑剂，将整个数据流跑通。
消息队列 RabbitMQ 正好适合用来做这个。</p>
<p>Rabbit 官网提到了一个套件 <a href="https://github.com/squaremo/rabbit.js">rabbit.js</a> 。
遗憾的是这个库是混合了 RabbitMQ 和 Node.JS，提供了一个封装好的 Node.JS 库，
而我想要的仅仅是一个 AMPQ 协议驱动。<a href="https://github.com/postwait/node-amqp/blob/master/amqp.js">node-amqp</a> 则是我们需要的驱动。</p>
<h3>Demo</h3>
<p>服务器接收者脚本：</p>
<p>``` js app-amqp.js
/<em> global __dirname, console </em>/</p>
<p>var conn = require('amqp').createConnection({ url: 'amqp://localhost'});</p>
<p>console.log('socket works');
conn.on('ready', function() {
    console.log('conn ready');
    conn.queue('socket.io', {passive: true}, function(queue){
        queue.subscribe(function (json, headers, deliveryInfo) {
            console.log('#json:')
            view(json);
            console.log('#headers:')
            view(headers);
            console.log('#deliveryInfo:')
            view(deliveryInfo);
        });
    });
});</p>
<p>conn.on('error', function() {
    console.error('error');
});</p>
<p>function view(obj) {
    for (var i in obj) {
        if(obj.hasOwnProperty(i)) {
            console.log(i + ': ' + obj[i]);
        }
    }
}</p>
<div class="highlight"><pre><span class="err">用</span> <span class="n">Python</span> <span class="err">写的发送者脚本：</span>

<span class="err">```</span> <span class="n">python</span> <span class="n">producter</span><span class="p">.</span><span class="n">py</span>
<span class="cp"># coding=utf-8</span>
<span class="cp">#! /usr/bin/env python2</span>

<span class="n">import</span> <span class="n">pika</span>
<span class="n">import</span> <span class="n">json</span>
<span class="n">import</span> <span class="n">logging</span>
<span class="n">import</span> <span class="n">time</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">getLogger</span><span class="p">()</span>

<span class="n">def</span> <span class="n">main</span><span class="p">()</span><span class="o">:</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">pika</span><span class="p">.</span><span class="n">BlockingConnection</span><span class="p">(</span>
        <span class="n">pika</span><span class="p">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="err">&#39;</span><span class="n">localhost</span><span class="err">&#39;</span><span class="p">))</span>
    <span class="n">chan</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">channel</span><span class="p">()</span>
    <span class="n">chan</span><span class="p">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="err">&#39;</span><span class="n">socket</span><span class="p">.</span><span class="n">io</span><span class="err">&#39;</span><span class="p">)</span>

    <span class="n">count</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="err">&#39;</span><span class="n">no</span><span class="err">&#39;</span><span class="o">:</span> <span class="n">count</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">some</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">Message</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">u</span><span class="err">&#39;比如&#39;</span><span class="o">:</span> <span class="n">u</span><span class="err">&#39;中文信息&#39;</span><span class="p">}</span>
        <span class="n">publish_text</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">socket</span><span class="p">.</span><span class="n">io</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">u</span><span class="err">&#39;</span><span class="n">text</span> <span class="o">%</span><span class="n">d</span><span class="err">&#39;</span> <span class="o">%</span><span class="n">count</span><span class="p">)</span>
        <span class="n">publish_json</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">socket</span><span class="p">.</span><span class="n">io</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="err">&#39;</span><span class="n">add</span> <span class="n">one</span> <span class="n">message</span> <span class="n">to</span> <span class="n">RabbitMQ</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="err">#</span><span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="err">#</span> <span class="n">sleep</span> <span class="mi">5</span> <span class="n">sec</span>
        <span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span>

<span class="n">def</span> <span class="n">publish_text</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span><span class="o">:</span>
    <span class="n">channel</span><span class="p">.</span><span class="n">basic_publish</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="err">&#39;&#39;</span><span class="p">,</span>
                          <span class="n">routing_key</span><span class="o">=</span><span class="n">queue</span><span class="p">,</span>
                          <span class="n">body</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">message</span><span class="p">),</span>
                          <span class="n">properties</span><span class="o">=</span><span class="n">pika</span><span class="p">.</span><span class="n">BasicProperties</span><span class="p">(</span>
                              <span class="n">content_type</span><span class="o">=</span><span class="err">&#39;</span><span class="n">text</span><span class="o">/</span><span class="n">plain</span><span class="err">&#39;</span><span class="p">,</span>
                              <span class="n">content_encoding</span><span class="o">=</span><span class="err">&#39;</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span><span class="err">&#39;</span><span class="p">,</span>
                              <span class="n">delivery_mode</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                         <span class="p">)</span>

<span class="n">def</span> <span class="n">publish_json</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span><span class="o">:</span>
    <span class="n">channel</span><span class="p">.</span><span class="n">basic_publish</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="err">&#39;&#39;</span><span class="p">,</span>
                          <span class="n">routing_key</span><span class="o">=</span><span class="n">queue</span><span class="p">,</span>
                          <span class="n">body</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">message</span><span class="p">),</span>
                          <span class="n">properties</span><span class="o">=</span><span class="n">pika</span><span class="p">.</span><span class="n">BasicProperties</span><span class="p">(</span>
                              <span class="n">content_type</span><span class="o">=</span><span class="err">&#39;</span><span class="n">application</span><span class="o">/</span><span class="n">json</span><span class="err">&#39;</span><span class="p">,</span>
                              <span class="n">content_encoding</span><span class="o">=</span><span class="err">&#39;</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span><span class="err">&#39;</span><span class="p">,</span>
                              <span class="n">delivery_mode</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                         <span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="err">&#39;</span><span class="n">__main__</span><span class="err">&#39;</span><span class="o">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>


<p>使用 <code>node ./app-amqp.js</code> 运行 Node.JS 服务器，然后运行 <code>producter.py</code> 产生
RabbitMQ Message，我使用的数据格式是序列化的 JSON 字串，
还有 <code>JSON, Thrift, Protocol Buffers, MessagePack</code> 这些格式可供选择。运行结果如下：</p>
<div class="highlight"><pre>#json:
data: &quot;text 1&quot;
UnicodeEncodeError: &#39;ascii&#39; codec can&#39;t encode characters in position 0-3: ordinal not icontentType: text/plain
#headers:
#deliveryInfo:
contentType: text/plain
contentEncoding: utf-8
deliveryMode: 1
queue: socket.io
deliveryTag: 19
redelivered: false
exchange:
routingKey: socket.io
consumerTag: node-amqp-10880-0.06487216474488378
#json:
比如: 中文信息
some: Message
no: 1
#headers:
#deliveryInfo:
contentType: application/json
contentEncoding: utf-8
deliveryMode: 1
queue: socket.io
deliveryTag: 20
redelivered: false
exchange:
routingKey: socket.io
consumerTag: node-amqp-10880-0.06487216474488378
</pre></div>


<p>里面有两个 Message，发送数据格式为 <code>text/plain</code> 和 <code>application/json</code> 。</p>
<p>参考链接：</p>
<ul>
<li><a href="http://pika.github.com/">Pika Document</a></li>
</ul>
<h2>Socket.IO + RabbitMQ</h2>
<p>最后提供 Socket.IO + RabbitMQ 的完整 Demo，客户端会实时接受到来自消息发送者的消息。</p>
<p>``` js app-amqp.socket.js
/<em> global __dirname, console </em>/</p>
<p>var app = require('http').createServer(handler),
    io = require('socket.io').listen(app),
    fs = require('fs');</p>
<p>app.listen(8080);</p>
<p>function handler(req, res) {
    fs.readFile(__dirname + '/index.html',
        function (err, data) {
            if (err) {
                res.writeHead(500);
                return res.end('Error loading index.html');
            }</p>
<div class="highlight"><pre>        <span class="n">res</span><span class="p">.</span><span class="n">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
        <span class="n">res</span><span class="p">.</span><span class="n">end</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
    <span class="p">});</span>
</pre></div>


<p>}</p>
<p>io.sockets.on('connection', function (socket) {
    console.log('io ready');</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">conn</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;amqp&#39;</span><span class="p">).</span><span class="nx">createConnection</span><span class="p">({</span> <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;amqp://localhost&#39;</span><span class="p">});</span>
<span class="nx">conn</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;conn ready&#39;</span><span class="p">);</span>
    <span class="nx">conn</span><span class="p">.</span><span class="nx">queue</span><span class="p">(</span><span class="s1">&#39;socket.io&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">passive</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">queue</span><span class="p">){</span>
        <span class="nx">queue</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">json</span><span class="p">,</span> <span class="nx">headers</span><span class="p">,</span> <span class="nx">deliveryInfo</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">deliveryInfo</span><span class="p">.</span><span class="nx">contentType</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">deliveryInfo</span><span class="p">.</span><span class="nx">contentType</span> <span class="o">==</span> <span class="s1">&#39;application/json&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;news&#39;</span><span class="p">,</span> <span class="nx">json</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">deliveryInfo</span><span class="p">.</span><span class="nx">contentType</span> <span class="o">==</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;news&#39;</span><span class="p">,</span> <span class="nx">json</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>


<p>});</p>
<div class="highlight"><pre><span class="err">在运行</span> <span class="err">`</span><span class="n">producter</span><span class="p">.</span><span class="n">py</span><span class="err">`</span> <span class="err">后，</span><span class="n">Python</span> <span class="err">脚本持续产生</span> <span class="n">Message</span> <span class="err">到</span> <span class="n">RabbitMQ</span><span class="err">，</span>
<span class="err">`</span><span class="n">app</span><span class="o">-</span><span class="n">amqp</span><span class="o">-</span><span class="n">socket</span><span class="p">.</span><span class="n">js</span><span class="err">`</span> <span class="err">订阅读取</span> <span class="n">Message</span> <span class="err">并推送到浏览器端。</span>
<span class="err">浏览器可以在</span> <span class="n">Console</span> <span class="err">里面看到日志：</span>

<span class="err">```</span> <span class="n">text</span>
<span class="n">Object</span> <span class="p">{</span> <span class="err">比如</span><span class="o">=</span><span class="s">&quot;中文信息&quot;</span><span class="p">,</span> <span class="n">some</span><span class="o">=</span><span class="s">&quot;Message&quot;</span><span class="p">,</span> <span class="n">no</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span>
</pre></div>


<p>至此，我们可以完成 WebApp -&gt; RabbitMQ -&gt; Socket.IO -&gt; Browser 的实时推送。</p>
            </div>
            <!-- /.entry-content -->
              
<hr>
<div class="panel">
<div class="panel-body">
   <small>原文链接: <a href="http://blog.log4d.com/2012/05/comet/">http://blog.log4d.com/2012/05/comet/</a></small><br>
   <small>3a1ff193cee606bd1e2ea554a16353ee</small>
</div>
</div>

<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
	<span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_tools_1"></a>
	<a class="jiathis_button_tools_2"></a>
	<a class="jiathis_button_tools_3"></a>
	<a class="jiathis_button_tools_4"></a>
	<a href="http://www.jiathis.com/share?uid=1604940" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
	<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config = {data_track_clickback:'true'};
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1604940" charset="utf-8"></script>
<!-- JiaThis Button END -->
    <hr />
    <section class="comments" id="comments">
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'log4d'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        </script>
		<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
		<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    

    </section>
        </article>
    </section>

        </div>
    </div>
    <div class="row">
        <div class="col-lg-3 col-lg-offset-2" id="sidebar">
<aside>
    <section>
        <ul class="list-group list-group-flush">
                <li class="list-group-item"><h4><i class="icon-home icon-large"></i>Social</h4></li>
                    <li class="list-group-item"><a href="http://twitter.com/alswl"><i
                        class=" icon-twitter-sign icon-large"></i>twitter
                    </a></li>
                    <li class="list-group-item"><a href="https://github.com/alswl"><i
                        class=" icon-github-sign icon-large"></i>github
                    </a></li>
                    <li class="list-group-item"><a href="http://weibo.com/alswlx"><i
                        class=" icon-weibo  icon-weibo-sign icon-large"></i>weibo
                    </a></li>
        </ul>
    </section>
</aside>        </div>
        <div class="col-lg-3" id="sidebar">
<aside>
    <section>
        <ul class="list-group list-group-flush">

                <li class="list-group-item"><h4><i class="icon-home icon-large"></i>Categories</h4></li>
                    <li class="list-group-item">
                        <a href="/category/c/">
                            <i class="icon-folder-open icon-large"></i>C
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/cheng-xu-ren-sheng/">
                            <i class="icon-folder-open icon-large"></i>程序人生
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/delphibian-cheng/">
                            <i class="icon-folder-open icon-large"></i>Delphi编程
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/dotnet/">
                            <i class="icon-folder-open icon-large"></i>dotNet
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/flashbian-cheng/">
                            <i class="icon-folder-open icon-large"></i>Flash编程
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/gan-wu/">
                            <i class="icon-folder-open icon-large"></i>感悟
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/gong-yu-shan-qi-shi-bi-xian-li-qi-qi/">
                            <i class="icon-folder-open icon-large"></i>工欲善其事必先利其器
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/guan-zhu-hu-lian-wang/">
                            <i class="icon-folder-open icon-large"></i>关注互联网
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/java/">
                            <i class="icon-folder-open icon-large"></i>Java
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/ji-zhu-da-ren/">
                            <i class="icon-folder-open icon-large"></i>技术达人
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/jian-zhan/">
                            <i class="icon-folder-open icon-large"></i>建站
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/jian-zhan-xin-de/">
                            <i class="icon-folder-open icon-large"></i>建站心得
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/linuxer/">
                            <i class="icon-folder-open icon-large"></i>Linuxer
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/mei-shi-peng-ren/">
                            <i class="icon-folder-open icon-large"></i>美食|烹饪
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/microsoft-net/">
                            <i class="icon-folder-open icon-large"></i>Microsoft .Net
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/net-zong-he-ji-zhu/">
                            <i class="icon-folder-open icon-large"></i>.Net, 综合技术
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/phpbian-cheng/">
                            <i class="icon-folder-open icon-large"></i>PHP编程
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/pythonbian-cheng/">
                            <i class="icon-folder-open icon-large"></i>Python编程
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/qian-duan/">
                            <i class="icon-folder-open icon-large"></i>前端
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/qing-chun-de-cai-hong/">
                            <i class="icon-folder-open icon-large"></i>青春的彩虹
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/ri-ji/">
                            <i class="icon-folder-open icon-large"></i>日记
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/ruan-jian-kai-fa-he-xiang-mu-guan-li/">
                            <i class="icon-folder-open icon-large"></i>软件开发和项目管理
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/ruby-bian-cheng/">
                            <i class="icon-folder-open icon-large"></i>Ruby 编程
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/shi-jue-she-ji/">
                            <i class="icon-folder-open icon-large"></i>视觉设计
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/sui-sui-nian/">
                            <i class="icon-folder-open icon-large"></i>碎碎念
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/webqian-duan/">
                            <i class="icon-folder-open icon-large"></i>Web前端
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/wu-hua-ba-men/">
                            <i class="icon-folder-open icon-large"></i>五花八门
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/xiang-mu-guan-li/">
                            <i class="icon-folder-open icon-large"></i>项目管理
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/xing-neng/">
                            <i class="icon-folder-open icon-large"></i>性能
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/xue-hai-wu-ya/">
                            <i class="icon-folder-open icon-large"></i>学海无涯
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/yi-dong-shou-chi/">
                            <i class="icon-folder-open icon-large"></i>移动手持
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/ying-jian/">
                            <i class="icon-folder-open icon-large"></i>硬件
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/yu-le/">
                            <i class="icon-folder-open icon-large"></i>娱乐
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="/category/zong-he-ji-zhu/">
                            <i class="icon-folder-open icon-large"></i>综合技术
                        </a>
                    </li>

        </ul>
    </section>
</aside>        </div>
    </div>
</div>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="/theme/js/respond.min.js"></script>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'log4d'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
</body>
</html>