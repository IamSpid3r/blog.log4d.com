<!DOCTYPE html>
<html lang="en"
>
<head>
    <title>使用nose做测试 - Log4D</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="http://blog.log4d.com/2011/09/nose/">

        <meta name="author" content="alswl" />
        <meta name="keywords" content="Python,nose,Pylons" />
        <meta name="description" content="不做单元测试的程序员不是好程序员。最近我在Pylons下面做开发， 使用 nose 做单元测试，颇有心得， 在这里分享一下。 1. Pylons中依赖包 先简单介绍一下Pylons, Pylons与其说是一个框架，不如说是一堆框架的组合， Pylons在其中做到一个胶水的作用。Pylons依赖的包如下。 breaker，缓存和Session FormEncode，用户输入检查 Mako，模板渲染 nose，自动化测试 Paste，服务器 Routes, 路由 Tempita，Paste的模板 Weberror WebOb，提供WSGI请求响应等对象 WebTest，Paste自带的测试小框架， 提供TestResponse和TestRequest两个有用的小东西 Pylons的测试主要使用的其中的 Paste / nose / WebOb / WebTest。 遇到问题的时候，可以去翻一翻上面的文档。 2. Pylons中测试目录结构 目录结构如下 ├─config ├─controllers ├─lib ├─model ├─public ├─templates ..." />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://blog.log4d.com/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="http://blog.log4d.com/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://blog.log4d.com/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="http://blog.log4d.com/theme/css/style.css" type="text/css"/>

    <link href="http://blog.log4d.com/atom.xml" type="application/atom+xml" rel="alternate" title="Log4D Atom Feed" />
    <link href="http://blog.log4d.com/rss.xml" type="application/rss+xml" rel="alternate" title="Log4D RSS Feed" />

</head>
<body>

<div class="navbar navbar-default" role="navigation">
    <div class="container  col-lg-8 col-lg-offset-2">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://blog.log4d.com/" class="navbar-brand">
Log4D            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="/tags/">Tags</a></li>
                    <li><a href="/links/">Links</a></li>
                    <li><a href="/about/">About</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://blog.log4d.com/archives/"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<div class="container">
    <div class="row">
        <div class="col-lg-8 col-lg-offset-2">

    <section id="content">
        <article class="article-detail">
            <header class="page-header">
                <h1 class="title">
                    <a href="http://blog.log4d.com/2011/09/nose/"
                       rel="bookmark"
                       title="Permalink to 使用nose做测试">
                        使用nose做测试
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2011-09-22T00:00:00"> 2011-09-22</time>
    </span>



<span class="label label-default">Tags</span>
	<a href="http://blog.log4d.com/tag/python/">Python</a>
        /
	<a href="http://blog.log4d.com/tag/nose/">nose</a>
        /
	<a href="http://blog.log4d.com/tag/pylons/">Pylons</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>不做单元测试的程序员不是好程序员。最近我在Pylons下面做开发， 使用
<a href="http://readthedocs.org/docs/nose/en/latest">nose</a> 做单元测试，颇有心得， 在这里分享一下。</p>
<h2>1. Pylons中依赖包</h2>
<p>先简单介绍一下Pylons, Pylons与其说是一个框架，不如说是一堆框架的组合， Pylons在其中做到一个胶水的作用。Pylons依赖的包如下。</p>
<ul>
<li><a href="https://github.com/danielfm/pybreaker">breaker，缓存和Session</a></li>
<li><a href="http://formencode.org/">FormEncode，用户输入检查</a></li>
<li><a href="http://www.makotemplates.org/">Mako，模板渲染</a></li>
<li><a href="http://readthedocs.org/docs/nose/en/latest/">nose，自动化测试</a></li>
<li><a href="http://pythonpaste.org/script/">Paste，服务器</a></li>
<li><a href="http://routes.groovie.org/">Routes, 路由</a></li>
<li><a href="http://pythonpaste.org/tempita/">Tempita，Paste的模板</a></li>
<li><a href="http://packages.python.org/WebCore/modules/thirdparty/weberror.html">Weberror</a></li>
<li><a href="http://docs.webob.org/en/latest/index.html">WebOb，提供WSGI请求响应等对象</a></li>
<li><a href="http://pythonpaste.org/webtest/">WebTest，Paste自带的测试小框架， 提供TestResponse和TestRequest两个有用的小东西</a></li>
</ul>
<p>Pylons的测试主要使用的其中的 Paste / nose / WebOb / WebTest。 遇到问题的时候，可以去翻一翻上面的文档。</p>
<h2>2. Pylons中测试目录结构</h2>
<p>目录结构如下</p>
<div class="highlight"><pre><span class="err">├─</span><span class="nx">config</span>
<span class="err">├─</span><span class="nx">controllers</span>
<span class="err">├─</span><span class="nx">lib</span>
<span class="err">├─</span><span class="nx">model</span>
<span class="err">├─</span><span class="kr">public</span>
<span class="err">├─</span><span class="nx">templates</span>
<span class="err">└─</span><span class="nx">tests</span>
    <span class="err">└─</span><span class="nx">functional</span>
</pre></div>


<p>目录中的 <code>config / controllers / lib / model / public</code>
在不同的web框架下面可能会略有差别，在这里我不关注他们，我关注 <code>tests / functional</code> 中存放相应的测试脚本，比如
<code>test_user.py</code></p>
<h2>3. 第一个简单的测试用例</h2>
<h3>3.1. 撰写单元测试文件</h3>
<p>最简单的test脚本如下</p>
<div class="highlight"><pre><span class="n">from</span> <span class="n">myb</span><span class="p">.</span><span class="n">tests</span> <span class="n">import</span> <span class="o">*</span>
</pre></div>


<p>class TestIndexController(TestController):</p>
<p>def test_index(self):</p>
<p>pass</p>
<h1>Test response...</h1>
<p>这里我们从 <code>myb.tests</code> 这个目录下面引入了所有包 （其实起作用的是 <code>__init__.py</code> ）</p>
<p><code>__init__.py</code> 如下：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>
<span class="c">#coding: utf-8</span>
<span class="kn">from</span> <span class="nn">webob.headers</span> <span class="kn">import</span> <span class="n">ResponseHeaders</span>
<span class="kn">from</span> <span class="nn">unittest</span> <span class="kn">import</span> <span class="n">TestCase</span>
</pre></div>
</td></tr></table>

<p>from paste.deploy import loadapp</p>
<p>from paste.script.appinstall import SetupCommand</p>
<p>from pylons import url</p>
<p>from routes.util import URLGenerator</p>
<p>from webtest import TestApp</p>
<p>import pylons.test</p>
<p><strong>all</strong> = ['environ', 'url', 'TestController']</p>
<h1>Invoke websetup with the current config file</h1>
<p>SetupCommand('setup-app').run([pylons.test.pylonsapp.config['<strong>file</strong>']])</p>
<p>environ = {}</p>
<p>class TestController(TestCase):</p>
<p>def <strong>init</strong>(self, <em>args, </em>*kwargs):</p>
<p>wsgiapp = pylons.test.pylonsapp</p>
<p>config = wsgiapp.config</p>
<p>self.app = TestApp(wsgiapp)</p>
<p>url._push_object(URLGenerator(config['routes.map'], environ))</p>
<p>TestCase.<strong>init</strong>(self, <em>args, </em>*kwargs)</p>
<p>可以看到，这里使用了 <code>TestController</code> 继承了 <code>TestCase</code> 这个单元测试基类， 并且在里面进行了web应用的环境初始化。</p>
<h3>3.2. 撰写测试配置文件</h3>
<p>上文撰写了一个最简单的测试代码，我们接着做一些单元测试配置。</p>
<p>在app应用的同级文件里面，修改 <code>test.ini</code> 文件。</p>
<div class="highlight"><pre><span class="k">[DEFAULT]</span>
<span class="na">debug</span> <span class="o">=</span> <span class="s">true</span>
<span class="c1">#email_to = you@yourdomain.com</span>
<span class="na">smtp_server</span> <span class="o">=</span> <span class="s">localhost</span>
<span class="na">error_email_from</span> <span class="o">=</span> <span class="s">paste@localhost</span>
</pre></div>


<p>[server:main]</p>
<p>use = egg:Paste#http</p>
<p>host = 127.0.0.1</p>
<p>port = 5000</p>
<p>[app:main]</p>
<p>use = config:development.ini</p>
<p>sqlalchemy.url =
mysql://username:password@localhost/myb_test?charset=utf8&amp;use_unicode=1</p>
<h1>Logging configuration</h1>
<p>[loggers]</p>
<p>keys = root, routes, myb, sqlalchemy</p>
<p>[handlers]</p>
<p>keys = console</p>
<p>[formatters]</p>
<p>keys = generic</p>
<p>[logger_root]</p>
<p>level = INFO</p>
<p>handlers = console</p>
<p>[logger_routes]</p>
<p>level = INFO</p>
<p>handlers =</p>
<p>qualname = routes.middleware</p>
<h1>"level = DEBUG" logs the route matched and routing variables.</h1>
<p>[logger_myb]</p>
<p>level = DEBUG</p>
<p>handlers =</p>
<p>qualname = myb</p>
<p>[logger_sqlalchemy]</p>
<p>level = INFO</p>
<p>handlers =</p>
<p>qualname = sqlalchemy.engine</p>
<h1>"level = INFO" logs SQL queries.</h1>
<h1>"level = DEBUG" logs SQL queries and results.</h1>
<h1>"level = WARN" logs neither. (Recommended for production systems.)</h1>
<p>[handler_console]</p>
<p>class = StreamHandler</p>
<p>args = (sys.stderr,)</p>
<p>level = NOTSET</p>
<p>formatter = generic</p>
<p>[formatter_generic]</p>
<p>format = %(asctime)s,%(msecs)03d %(levelname)-5.5s [%(name)s] [%(threadName)s]
%(message)s</p>
<p>datefmt = %H:%M:%S</p>
<p>这个配置文件设定了基本调试信息，数据库（使用myb_test数据库来避免修改原始数据） ，log方式。</p>
<p>在 <code>[app:main]</code> 里面，我直接引用了 <code>development.ini</code> 的配置。</p>
<h3>3.3. 运行nose</h3>
<p>在shell里面切换到app所在的目录（test.ini）所在的目录，运行 <code>nosetests
myb/tests/functional/test_hello world.py</code> 。 之后会出现一些log内容，不出意外的话，应该出现 <code>OK</code> 。</p>
<p>如果遇到 <code>FAILED</code> ，那就根据错误提示的信息来查错。 nose会输出log的信息和print标准输出的信息。</p>
<h2>4. 高级一点的测试方法</h2>
<p>在开发过程中，我们需要判定单元测试是否正确，我罗列一些常见的用法</p>
<h3>4.1. 测试返回类型为HTTP STATUS的方法</h3>
<p>每次HTTP请求都会返回HTTP STATUS，正常是200，找不到是404，服务器错误是500， 我们可以根据这些返回状态值来判断测试是否跑通。</p>
<div class="highlight"><pre><span class="n">class</span> <span class="n">TestQuestionController</span><span class="p">(</span><span class="n">TestController</span><span class="p">)</span><span class="o">:</span>
</pre></div>


<p>def test_suggest_question(self):</p>
<h1>正常返回200</h1>
<p>response = self.app.get(url=url(controller='question',</p>
<p>action='suggest_question',</p>
<p>),</p>
<p>params={</p>
<p>},</p>
<p>headers=self.headers,</p>
<p>status=200,</p>
<p>)</p>
<h1>不存在的id返回404</h1>
<p>response = self.app.get(url=url(controller='question',</p>
<p>action='suggest_question',</p>
<p>),</p>
<p>params={</p>
<p>'id': '345',</p>
<p>},</p>
<p>headers=self.headers,</p>
<p>status=404,</p>
<p>)</p>
<p>我习惯使用 <code>url()</code> 方法来生成url，这样一方面不用记住冗长的url， 另外在url路由表发生变化之后，也不用去改变测试代码。</p>
<h3>4.2. 测试返回类型为html的方法</h3>
<div class="highlight"><pre>    <span class="n">def</span> <span class="n">test_register</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">(</span><span class="n">controller</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">users</span><span class="err">&#39;</span><span class="p">,</span>
                                     <span class="n">action</span> <span class="o">=</span> <span class="err">&#39;</span><span class="k">register</span><span class="err">&#39;</span><span class="p">,</span>
                                     <span class="n">format</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">json</span><span class="err">&#39;</span><span class="p">),</span>
                                 <span class="p">{</span>
                                     <span class="err">&#39;</span><span class="n">login_name</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">nose_json</span><span class="err">&#39;</span><span class="p">,</span>
                                     <span class="err">&#39;</span><span class="n">login_pass</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="mi">123</span><span class="err">&#39;</span><span class="p">,</span>
                                     <span class="err">&#39;</span><span class="n">user_name</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;测试机器人</span><span class="n">_json</span><span class="err">&#39;</span><span class="p">,</span>
                                 <span class="p">},</span>
                                 <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
                                 <span class="p">)</span>
        <span class="n">assert</span> <span class="err">&#39;</span><span class="mi">202</span><span class="n">cb962ac59075b964b07152d234b70</span><span class="err">&#39;</span> <span class="n">in</span> <span class="n">response</span><span class="p">.</span><span class="n">body</span> <span class="err">#返回的加密密码</span>
        <span class="err">#</span><span class="n">log</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span> <span class="n">u</span><span class="sc">&#39;器&#39;</span> <span class="n">in</span> <span class="n">response</span><span class="p">.</span><span class="n">unicode_body</span><span class="p">)</span> <span class="err">#无法测试中文</span>
        <span class="err">#</span><span class="n">log</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span> <span class="n">u</span><span class="err">&#39;测试机器人</span><span class="n">_json</span><span class="err">&#39;</span> <span class="n">in</span> <span class="n">response</span><span class="p">.</span><span class="n">unicode_body</span><span class="p">)</span> <span class="err">#无法测试中文</span>
</pre></div>


<p>使用 <code>response.body</code> 来判定html里面的内容（这里对中文支持不太好）。</p>
<h3>4.3. 测试返回类型为json的方法</h3>
<p>AJAX请求正常返回的状态吗都是200，我们需要判定里面的内容进行assert</p>
<div class="highlight"><pre>        <span class="n">response</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="err">&#39;</span><span class="n">invitation</span><span class="err">&#39;</span><span class="p">,</span>
                                         <span class="n">action</span><span class="o">=</span><span class="err">&#39;</span><span class="n">invite_by_mail</span><span class="err">&#39;</span><span class="p">),</span>
                                 <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                                     <span class="err">&#39;</span><span class="n">to_address</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;&#39;</span><span class="p">,</span>
                                     <span class="err">&#39;</span><span class="n">to_user_name</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;大爷&#39;</span><span class="p">,</span>
                                 <span class="p">},</span>
                                 <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">,</span>
                                 <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
                                <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="err">&#39;</span><span class="n">success</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">False</span><span class="p">)</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="err">&#39;</span><span class="n">message</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">u</span><span class="err">&#39;发送失败：你妹不漂亮&#39;</span><span class="p">)</span>
</pre></div>


<h3>4.4. 测试返回类型为重定向的方法</h3>
<p>这是HTTP状态吗的特殊形式，比如登录之后做一次跳转之类的。</p>
<div class="highlight"><pre>    <span class="n">def</span> <span class="n">test_add</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="err">#成功之后返回</span><span class="mi">302</span><span class="err">做跳转，同时判定返回内容中跳转路径</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="err">&#39;</span><span class="n">question</span><span class="err">&#39;</span><span class="p">,</span>
                                         <span class="n">action</span><span class="o">=</span><span class="err">&#39;</span><span class="n">add</span><span class="err">&#39;</span><span class="p">,</span>
                                         <span class="p">),</span>
                                 <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                                     <span class="err">&#39;</span><span class="n">question_title</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">hwti1</span><span class="err">&#39;</span><span class="p">,</span>
                                     <span class="err">&#39;</span><span class="n">question_content</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">wgtinzrs1</span><span class="err">&#39;</span><span class="p">,</span>
                                 <span class="p">},</span>
                                 <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">,</span>
                                 <span class="n">status</span><span class="o">=</span><span class="mi">302</span><span class="p">,</span>
                                <span class="p">)</span>
        <span class="n">assert</span> <span class="n">re</span><span class="p">.</span><span class="n">match</span><span class="p">(</span><span class="n">r</span><span class="err">&#39;</span><span class="o">^</span><span class="n">http</span><span class="o">:</span><span class="c1">//localhost/question/d*&#39;,</span>
                        <span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">[</span><span class="err">&#39;</span><span class="n">Location</span><span class="err">&#39;</span><span class="p">])</span>
</pre></div>


<h3>4.5. 用户登录生成Session</h3>
<p>有些方法需要登录后才能运行，这依赖于服务器和浏览器之间的Cookie。如果要对这类
方法进行测试，我们需要事先获取Cookie，再在每一次请求发出的时候附带这个Cookie。</p>
<p>在下面的方法中，我实现了用户登录操作。 在test目录下的 <code>__init.py__</code> 中 <code>TestController</code> 加入新方法 <code>login()</code></p>
<div class="highlight"><pre>    <span class="n">def</span> <span class="n">login</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">login_name</span><span class="p">,</span> <span class="n">login_pass</span><span class="p">)</span><span class="o">:</span>
        <span class="s">&quot;&quot;&quot;</span>
        <span class="err">用户登录操作，获取</span><span class="n">Cookie</span>
</pre></div>


<p>"""</p>
<p>response = self.app.post(url=url(controller='users',</p>
<p>action='login'),</p>
<p>params={</p>
<p>'login_name': login_name,</p>
<p>'login_pass': login_pass,</p>
<p>},</p>
<p>)</p>
<p>cookie = response.headers.getall('Set-cookie')[0]</p>
<p>self.headers = ResponseHeaders()</p>
<p>self.headers.add('Cookie', cookie)</p>
<p>这样就可以通过 <code>self.headers</code> 保存登录之后的cookie。</p>
<h3>4.6. 批量测试</h3>
<p>除了制定 <code>test_xxx.py</code> 文件进行单元测试，我们还可以直接使用 <code>nosetests</code> 测试所有测试用例。</p>
<div class="highlight"><pre><span class="n">nosetests</span>
<span class="c1">//该目录下需要存在 test.ini 配置文件</span>
</pre></div>


<h2>5. 遇到的问题</h2>
<h3>5.1. 编码问题</h3>
<div class="highlight"><pre>  <span class="n">File</span> <span class="s">&quot;buildbdist.win32eggwebtest__init__.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">211</span><span class="p">,</span> <span class="n">in</span> <span class="n">post</span>
    <span class="n">content_type</span><span class="o">=</span><span class="n">content_type</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">&quot;buildbdist.win32eggwebtest__init__.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">191</span><span class="p">,</span> <span class="n">in</span> <span class="n">_gen_request</span>
    <span class="n">expect_errors</span><span class="o">=</span><span class="n">expect_errors</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">&quot;buildbdist.win32eggwebtest__init__.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">370</span><span class="p">,</span> <span class="n">in</span> <span class="n">do_request</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">catch_exc_info</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">&quot;buildbdist.win32eggwebobrequest.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1004</span><span class="p">,</span> <span class="n">in</span> <span class="n">get_response</span>
    <span class="n">application</span><span class="p">,</span> <span class="n">catch_exc_info</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">&quot;buildbdist.win32eggwebobrequest.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">977</span><span class="p">,</span> <span class="n">in</span> <span class="n">call_application</span>
    <span class="n">app_iter</span> <span class="o">=</span> <span class="n">application</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">&quot;buildbdist.win32eggwebtestlint.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">170</span><span class="p">,</span> <span class="n">in</span> <span class="n">lint_app</span>
    <span class="n">iterator</span> <span class="o">=</span> <span class="n">application</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response_wrapper</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">&quot;d:programmingpython26libsite-packagespaste-1.7.5.1-py2.6.eggpastecascade.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">130</span><span class="p">,</span> <span class="n">in</span> <span class="n">__call__</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">apps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">](</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">&quot;d:programmingpython26libsite-packagespaste-1.7.5.1-py2.6.eggpasteregistry.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">379</span><span class="p">,</span> <span class="n">in</span> <span class="n">__call__</span>
    <span class="n">app_iter</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">application</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">&quot;d:programmingpython26libsite-packagespylons-1.0-py2.6.eggpylonsmiddleware.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">150</span><span class="p">,</span> <span class="n">in</span> <span class="n">__call__</span>
    <span class="n">self</span><span class="p">.</span><span class="n">app</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">catch_exc_info</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">&quot;d:programmingpython26libsite-packagespylons-1.0-py2.6.eggpylonsutil.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">48</span><span class="p">,</span> <span class="n">in</span> <span class="n">call_wsgi_application</span>
    <span class="n">app_iter</span> <span class="o">=</span> <span class="n">application</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">&quot;d:programmingpython26libsite-packagesweberror-0.10.3-py2.6.eggweberrorevalexception.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">235</span><span class="p">,</span> <span class="n">in</span> <span class="n">__call__</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">respond</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">&quot;d:programmingpython26libsite-packagesweberror-0.10.3-py2.6.eggweberrorevalexception.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">418</span><span class="p">,</span> <span class="n">in</span> <span class="n">respond</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">application</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">&quot;d:programmingpython26libsite-packagesbeaker-1.5.4-py2.6.eggbeakermiddleware.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">152</span><span class="p">,</span> <span class="n">in</span> <span class="n">__call__</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">wrap_app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">session_start_response</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">&quot;d:programmingpython26libsite-packagesroutes-1.12.3-py2.6.eggroutesmiddleware.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">131</span><span class="p">,</span> <span class="n">in</span> <span class="n">__call__</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">&quot;d:programmingpython26libsite-packagespylons-1.0-py2.6.eggpylonswsgiapp.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">107</span><span class="p">,</span> <span class="n">in</span> <span class="n">__call__</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">&quot;d:programmingpython26libsite-packagespylons-1.0-py2.6.eggpylonswsgiapp.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">312</span><span class="p">,</span> <span class="n">in</span> <span class="n">dispatch</span>
    <span class="k">return</span> <span class="n">controller</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">&quot;F:workxintongworkspaceMYB_WENDAmybmyblibbase.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">52</span><span class="p">,</span> <span class="n">in</span> <span class="n">__call__</span>
    <span class="k">return</span> <span class="n">WSGIController</span><span class="p">.</span><span class="n">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">&quot;d:programmingpython26libsite-packagespylons-1.0-py2.6.eggpylonscontrollerscore.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">266</span><span class="p">,</span> <span class="n">in</span> <span class="n">__call__</span>
    <span class="k">return</span> <span class="n">response</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">start_response</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">&quot;d:programmingpython26libsite-packageswebob-1.0.7-py2.6.eggwebobexc.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">517</span><span class="p">,</span> <span class="n">in</span> <span class="n">__call__</span>
    <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">&quot;d:programmingpython26libsite-packageswebob-1.0.7-py2.6.eggwebobexc.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">341</span><span class="p">,</span> <span class="n">in</span> <span class="n">__call__</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">generate_response</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">&quot;d:programmingpython26libsite-packageswebob-1.0.7-py2.6.eggwebobexc.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">322</span><span class="p">,</span> <span class="n">in</span> <span class="n">generate_response</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">plain_body</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">&quot;d:programmingpython26libsite-packageswebob-1.0.7-py2.6.eggwebobexc.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">301</span><span class="p">,</span> <span class="n">in</span> <span class="n">plain_body</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_make_body</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">no_escape</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">&quot;d:programmingpython26libsite-packageswebob-1.0.7-py2.6.eggwebobexc.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">294</span><span class="p">,</span> <span class="n">in</span> <span class="n">_make_body</span>
    <span class="n">args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">escape</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">&quot;d:programmingpython26libsite-packageswebob-1.0.7-py2.6.eggwebobexc.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">182</span><span class="p">,</span> <span class="n">in</span> <span class="n">no_escape</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
  <span class="n">File</span> <span class="s">&quot;d:programmingpython26libsite-packagespylons-1.0-py2.6.eggpylonsutil.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">112</span><span class="p">,</span> <span class="n">in</span> <span class="n">__repr__</span>
    <span class="n">value_repr</span> <span class="o">=</span> <span class="n">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="nl">UnicodeEncodeError:</span> <span class="err">&#39;</span><span class="n">ascii</span><span class="err">&#39;</span> <span class="n">codec</span> <span class="n">can</span><span class="err">&#39;</span><span class="n">t</span> <span class="n">encode</span> <span class="n">characters</span> <span class="n">in</span> <span class="n">position</span> <span class="mi">8</span><span class="o">-</span><span class="mi">18</span><span class="o">:</span> <span class="n">ordinal</span> <span class="n">not</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
</pre></div>


<p>这是一个明显由编码引起的错误。</p>
<p>修改pylons-1.0-py2.6.eggPylonsutil.py中112行修改为</p>
<div class="highlight"><pre><span class="k">try</span><span class="o">:</span>
    <span class="n">value_repr</span> <span class="o">=</span> <span class="n">repr</span><span class="o">(</span><span class="n">value</span><span class="o">)</span>
<span class="n">except</span> <span class="n">UnicodeEncodeError</span><span class="o">,</span> <span class="n">e</span><span class="o">:</span>
    <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s1">&#39;encode error in pylons/utils.py&#39;</span><span class="o">)</span>
    <span class="k">continue</span>
</pre></div>


<p>这样虽然不能从根本上解决问题，但是至少规避了问题。</p>
            </div>
            <!-- /.entry-content -->
              
<hr>
<div class="panel">
<div class="panel-body">
   <small>原文链接: <a href="http://blog.log4d.com/2011/09/nose/">http://blog.log4d.com/2011/09/nose/</a></small><br>
   <small>3a1ff193cee606bd1e2ea554a16353ee</small>
</div>
</div>

<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
	<span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_tools_1"></a>
	<a class="jiathis_button_tools_2"></a>
	<a class="jiathis_button_tools_3"></a>
	<a class="jiathis_button_tools_4"></a>
	<a href="http://www.jiathis.com/share?uid=1604940" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
	<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config = {data_track_clickback:'true'};
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1604940" charset="utf-8"></script>
<!-- JiaThis Button END -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'log4d'; // required: replace example with your forum shortname

                    var disqus_identifier = 'nose';
                var disqus_url = 'http://blog.log4d.com/2011/09/nose/';

            var disqus_config = function () {
                this.language = "en";
            };

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        </script>
		<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
		<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    

    </section>
        </article>
    </section>

        </div>
        <div class="col-lg-3 col-lg-offset-2" id="sidebar">

<aside>
    <section>
        <ul class="list-group list-group-flush">
                <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
                  <ul class="list-group" id="social">
                    <li class="list-group-item"><a href="http://blog.log4d.com/atom.xml"><i class="fa fa-rss-square fa-lg"></i> RSS</a></li>
                    <li class="list-group-item"><a href="http://twitter.com/alswl"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
                    <li class="list-group-item"><a href="https://github.com/alswl"><i class="fa fa-github-square fa-lg"></i> Github</a></li>
                    <li class="list-group-item"><a href="http://weibo.com/alswlx"><i class="fa fa-weibo fa-lg"></i> Weibo</a></li>
                  </ul>
                </li>




        </ul>
    </section>

</aside>        </div>
    <div class="col-lg-3" id="sidebar">
<aside>
    <section>
        <ul class="list-group list-group-flush">
                <li class="list-group-item"><a href="http://blog.log4d.com/"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Categories</span></h4></a>
                    <ul class="list-group" id="categories">
                        <li class="list-group-item">
                            <a href="http://blog.log4d.com/category/coding/">
                                <i class="fa fa-folder-open fa-lg"></i> Coding
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://blog.log4d.com/category/efficiency/">
                                <i class="fa fa-folder-open fa-lg"></i> Efficiency
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://blog.log4d.com/category/fun/">
                                <i class="fa fa-folder-open fa-lg"></i> Fun
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://blog.log4d.com/category/internet/">
                                <i class="fa fa-folder-open fa-lg"></i> Internet
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://blog.log4d.com/category/life/">
                                <i class="fa fa-folder-open fa-lg"></i> Life
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://blog.log4d.com/category/managment/">
                                <i class="fa fa-folder-open fa-lg"></i> Managment
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://blog.log4d.com/category/thinking/">
                                <i class="fa fa-folder-open fa-lg"></i> Thinking
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://blog.log4d.com/category/ui/">
                                <i class="fa fa-folder-open fa-lg"></i> UI
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://blog.log4d.com/category/view/">
                                <i class="fa fa-folder-open fa-lg"></i> View
                            </a>
                        </li>
                    </ul>
                </li>


        </ul>
    </section>

</aside>    </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2014 alswl
            &middot; Powered by <a href="https://github.com/alswl/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://blog.log4d.com/theme/js/jquery.min.js"></script>
<!--<script src="http://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>-->

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://blog.log4d.com/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://blog.log4d.com/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'log4d'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-8822123-3']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->
</body>
</html>